name: Build ComfyUI Desktop
on:
  workflow_dispatch:
permissions:
  contents: write
jobs:
  build-windows:
    name: Build ComfyUI Desktop - PyTorch ${{ matrix.pytorch_version }}
    runs-on: windows-latest
    strategy:
      matrix:
        pytorch_version: ['2.7']
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      - name: Extract version from pyproject.toml
        id: get_version
        run: |
          $VERSION = (Get-Content pyproject.toml | Select-String '^version = "(.+)"').Matches.Groups[1].Value
          echo "version=$VERSION" >> $env:GITHUB_OUTPUT
          echo "Extracted ComfyUI-nunchaku version: $VERSION"
        shell: pwsh
      - name: Get latest nunchaku release version
        id: get_nunchaku_version
        run: |
          $response = Invoke-RestMethod -Uri "https://api.github.com/repos/nunchaku-tech/nunchaku/releases/latest" -Headers @{ "User-Agent" = "GitHub Actions" }
          $NUNCHAKU_VERSION = $response.tag_name -replace '^v', ''
          echo "nunchaku_version=$NUNCHAKU_VERSION" >> $env:GITHUB_OUTPUT
          echo "Latest nunchaku release: $NUNCHAKU_VERSION"
        shell: pwsh
      - name: Run build script
        run: |
          cd ..
          ComfyUI-nunchaku\.github\workflows\build_comfyui_desktop.cmd
        shell: cmd
        env:
          NUNCHAKU_VERSION: ${{ steps.get_nunchaku_version.outputs.nunchaku_version }}
          TORCH_VERSION: ${{ matrix.pytorch_version }}
      - name: List build output
        run: |
          Get-ChildItem -Path "..\desktop\dist" -ErrorAction SilentlyContinue | Format-Table Name, Length, LastWriteTime
        shell: pwsh
        if: always()
      - name: Find build artifacts
        id: find_artifacts
        run: |
          $ARTIFACT_PATH = Get-ChildItem -Path "..\desktop\dist\Comfy-*-win.zip" | Select-Object -First 1 -ExpandProperty FullName
          echo "artifact_path=$ARTIFACT_PATH" >> $env:GITHUB_OUTPUT
          echo "Found artifact: $ARTIFACT_PATH"
        shell: pwsh
        if: success()
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: comfyui-desktop-pytorch-${{ matrix.pytorch_version }}
          path: ${{ steps.find_artifacts.outputs.artifact_path }}
          retention-days: 7
        if: success()
      - name: Upload Artifact to Existing Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          files: ${{ steps.find_artifacts.outputs.artifact_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        if: success()
